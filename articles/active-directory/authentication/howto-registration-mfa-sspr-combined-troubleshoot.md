---
title: Troubleshoot combined registration for Azure AD SSPR and MFA (preview)
description: Troubleshoot Azure AD Multi-Factor Authentication and self-service password reset combined registration (preview)

services: active-directory
ms.service: active-directory
ms.subservice: authentication
ms.topic: conceptual
ms.date: 02/20/2019

ms.author: joflore
author: MicrosoftGuyJFlo
manager: daveba
ms.reviewer: sahenry

ms.collection: M365-identity-device-management
---
# Troubleshooting combined security information registration (preview)

The information provided in this article can guide administrators who are troubleshooting issues with the combined registration experience reported by their end-users.

|     |
| --- |
| Combined security information registration for Azure Multi-Factor Authentication and Azure AD self-service password reset is a public preview feature of Azure Active Directory. For more information about previews, see  [Supplemental Terms of Use for Microsoft Azure Previews](https://azure.microsoft.com/support/legal/preview-supplemental-terms/)|
|     |

## Audit logs

The events logged for combined registration are under the “Authentication Methods” category in the Azure AD audit logs.

![Azure AD Audit logs interface showing some security info registration events for a new user in the directory](media/howto-registration-mfa-sspr-combined-troubleshoot/combined-security-info-audit-log.png)

The following lists all audit events generated by combined registration:

| Activity | Status | Reason | Description |
| --- | --- | --- | --- |
| User registered all required security info | Success | User registered all required security info. | This event occurs when a user has successfully completed registration.|
| User registered all required security info | Failure | User canceled security info registration. | This event occurs when a user cancels registration from interrupt mode.|
| User registered security info | Success | User registered "method". | This event occurs when a user registers an individual method. "Method" can be Authenticator app, Phone, Email, Security questions, App password, Alternate phone, etc.| 
| User reviewed security info | Success | User successfully reviewed security info. | This event occurs when a user clicks "Looks good" on the security info review page.|
| User reviewed security info | Failure | User failed to review security info. | This event occurs when a user clicks “Looks good” on the security info review page but something fails in the backend.|
| User deleted security info | Success | User deleted "method". | This event occurs when a user deletes an individual method. "Method" can be Authenticator app, Phone, Email, Security questions, App password, Alternate phone, etc.|
| User deleted security info | Failure | User failed to delete "method". | This event occurs when a user tries to delete a method but it fails for some reason. "Method" can be Authenticator app, Phone, Email, Security questions, App password, Alternate phone, etc.|
| User changed default security info | Success | User changed default security info to "method". | This event occurs when a user changes their default method. "Method" can be Authenticator app notification, code from my authenticator app or token, Call +X XXXXXXXXXX, Text a code to +X XXXXXXXXX, etc.|
| User changed default security info | Failure | User failed to change default security info to "method". | This event occurs when a user tries to change their default method but it fails for some reason. "Method" can be Authenticator app notification, a code from my authenticator app or token, Call +X XXXXXXXXXX, Text a code to +X XXXXXXXXX, etc.|

## Troubleshooting interrupt mode

| Symptom | Troubleshooting steps |
| --- | --- |
| I’m not seeing the methods I expected to see. | 1. Check if the user has an Azure AD administrator role. If yes, review the SSPR administrator policy differences. <br> 2. Determine whether the user is being interrupted due to MFA registration enforcement or SSPR registration enforcement. Review the flowchart under combined registration modes to determine which methods should be shown. <br> 3. Determine how recently the MFA or SSPR policy was changed. If the change was recent, it may take some time for the updated policy to propagate.|

## Troubleshooting manage mode

| Symptom | Troubleshooting steps |
| --- | --- |
| I don’t have the option to add a particular method. | 1. Determine whether the method is enabled for MFA or for SSPR. <br> 2. If the method is enabled, resave the policies and wait 1-2 hours before testing again. <br> 3. If the method is enabled, ensure that the user hasn’t already set up the maximum number of that method that they're allowed to set up.|

## Disable combined registration

When a user registers their phone number and/or mobile app in the new combined experience, our service stamps a set of flags (StrongAuthenticationMethods) for those methods on that user. This functionality allows the user to perform Azure Multi-Factor Authentication (MFA) with those methods whenever MFA is required.

The methods that users register through the new experience have the StrongAuthenticationMethods property set. If an admin enables the preview, users register through the new experience, and then the admin disables the preview, users may unknowingly be registered for MFA also.

If a user who has completed combined registration navigates to the current self-service password reset (SSPR) registration page, at [https://aka.ms/ssprsetup](https://aka.ms/ssprsetup), they will be prompted to perform MFA before they can access that page. This step is an expected behavior from a technical standpoint, but for users who were previously registered for SSPR only, this step is a new behavior. Although this extra step does improve the user’s security posture by providing an additional level of security, admins may want to roll back their users so that they are no longer capable of performing MFA.  

### How to roll back users

If you as an administrator want to reset a user's MFA settings, we have created a PowerShell script that will clear the StrongAuthenticationMethods property for a user’s mobile app and/or phone number. Running this script for your users means that they will need to re-register for MFA if needed. We recommend testing rollback with one or two users before rolling back all the affected users.

The steps that follow will help you roll back a user or group of users:

#### Prerequisites

1. You will need to install the appropriate Azure AD PowerShell modules. In a PowerShell window, run these commands to install the modules:

   ```powershell
   Install-Module -Name MSOnline
   Import-Module MSOnline
   ```

1. Save the list of affected user object ID/IDs to your machine as a text file with one ID per line. Make note of the location of the file.
1. Save the following script to your machine and make note of the location of the script:

```powershell
<# 
//********************************************************
//*                                                      *
//*   Copyright (C) Microsoft. All rights reserved.      *
//*                                                      *
//********************************************************
#>

param($path)

# Define Remediation Fn
function RemediateUser {

    param  
    (
        $ObjectId
    )

    $user = Get-MsolUser -ObjectId $ObjectId

    Write-Host "Checking if user is eligible for rollback: UPN: "  $user.UserPrincipalName  " ObjectId: "  $user.ObjectId -ForegroundColor Yellow

    $hasMfaRelyingParty = $false
    foreach($p in $user.StrongAuthenticationRequirements)
    {
        if ($p.RelyingParty -eq "*")
        {
            $hasMfaRelyingParty = $true
            Write-Host "User was enabled for per-user MFA." -ForegroundColor Yellow
        }
    }

    if ($user.StrongAuthenticationMethods.Count -gt 0 -and -not $hasMfaRelyingParty)
    {
        Write-Host $user.UserPrincipalName " is eligible for rollback" -ForegroundColor Yellow
        Write-Host "Rolling back user ..." -ForegroundColor Yellow
        Reset-MsolStrongAuthenticationMethodByUpn -UserPrincipalName $user.UserPrincipalName
        Write-Host "Successfully rolled back user " $user.UserPrincipalName -ForegroundColor Green
    }
    else
    {
        Write-Host $user.UserPrincipalName " is not eligible for rollback. No action required."
    }

    Write-Host ""
    Start-Sleep -Milliseconds 750
}

# Connect
Import-Module MSOnline
Connect-MsolService

foreach($line in Get-Content $path)
{
    RemediateUser -ObjectId $line
}
```

#### Rollback

In a PowerShell window, run the following command after updating the highlighted locations. Enter global administrator credentials when prompted. The script will output the outcome of each user update operation.

`<script location> -path <user file location>`

### Disable preview experience

To disable the preview experience for your users, complete the following steps:

1. Sign in to the Azure portal as a global administrator or user administrator.
2. Browse to **Azure Active Directory**, **User settings**, **Manage settings for access panel preview features**.
3. Under **Users can use preview features for registering and managing security info**, set the selector to **None** and click **Save**.

Users will no longer be prompted to register using the preview experience.

## Next steps

[Learn more about the public preview of combined registration for self-service password reset and Azure Multi-Factor Authentication](concept-registration-mfa-sspr-combined.md)
